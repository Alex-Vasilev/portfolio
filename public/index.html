<!DOCTYPE html>
<html>
    <head>
        <link href="https://fonts.googleapis.com/css?family=Catamaran:400,500,700,800,900|Josefin+Sans:100,100i,300,300i,400,400i,600,600i,700,700i|Julius+Sans+One|Maven+Pro:400,500,700,900" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="https://unpkg.com/vue@2.1.4/dist/vue.js"></script>
        <script src="https://unpkg.com/vue-router/dist/vue-router.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css">
        <!--<script src="build.js"></script>-->
        <meta name="viewport" content="width=device-width">
        <meta charset="utf-8">
        <title>avawesome</title>
    </head>
    <body>
        <div class="content"
             id="main-page">
            
            <div class="header">
                <router-link to="/" class="logo"></router-link>               
                <ul class="main-menu">
                    <li><router-link to="/about">About</router-link></li>
                    <li><router-link to="/contact">Contact</router-link></li>
                    <li><router-link to="/blog">Blog</router-link></li>
                    <li><router-link to="/works">Works</router-link></li>
                </ul>   
            </div>

             отображение компонента, для которого совпал путь 
            <transition name="component-fade" mode="out-in">
               <router-view></router-view>
            </transition>
        </div>
        <script src="build.js"></script>

        <script>
//home.welcome('Pidra');

const Home = {template: `<div class="blog-content home"> 
    <h2>Hello people!<br> <span>My name is Alex and<br>
            welcome to my fucking great website!</span></h2>
</div>`};
    
const Works = {template: `<div class="blog-content works"><h3>There's nothing here...yet</h3></div>`};

const Contact = {
    template: `<div class="blog-content contact">
        <h3>Contact</h3>
       <form @submit.prevent="onContactSubmit" class="container">
            <p class="contact-form-description">Say hello etc.</p>
           <div class="form-group">              
               <input class="contact-email"
                      name="email"
                      v-model="from"
                      placeholder="E-mail"/>
                <p v-show="from && !isEmailValid">Sasai</p>
           </div>
           <div class="form-group">              
               <textarea class="contact-message"
                        name="message" 
                        v-model="message"
                        placeholder="Message"
                        rows="4"></textarea>
                <p v-show="message && !isMessageValid">Or vishe gor</p>
           </div>
           <div class="panel-body">
               <button type="submit"
                       class="btn btn-sm btn-primary"
                       v-bind:disabled="fullInputs">Send</button>
           </div>
       </form>
        <transition name="component-fade" mode="out-in">
        <div v-if="success_message"
             class="success_message">Cool that you decided to write to me! Wait for reply in the near future</div>
        </transition>
        <div>
            <p class="email">aleksandr_vasilev1989@list.ru</p>
            <a class="phone" href="tel:+375445754785"> +375(44) 575 47 85 </a>
            <p class="city">Minsk</p>
        </div>
   </div>`,
        data: function(){
            return {
              success_message: false,
              from: '',
              message: '',
              fullInputs: true
            };
        },
    methods: {
        onContactSubmit: function(){
            var self = this;
            $.ajax({
                url: "api/contact",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                        from: this.from,
                        message: this.message
                    }),
                success: function () {  
                    self.from = '';
                    self.message = '';
                    console.log('send');
                    self.success_message = true;
                    setTimeout(function(){
                        self.success_message = false;
                    }, 3000);
                },
                error: function () {
                    console.log('ebanarot');
                }
            });
        }
    },
    
    computed: {
        isEmailValid() {
            return /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(this.from);
        },
        
        isMessageValid(){
            if(this.message.length > 3)
            return  true;
            else 
            return false;
        }
    }
};
    
const About = {template: `<div class="blog-content about"><h3>About</h3>
<p class="container">Hello! My name is Alex. I am 28 years old. I'm engaged in front-end development.
Now we are working with the guys to develop a cool callback widget
 with CRM and analytics. Here I will keep a small blog, in which I
 will describe interesting things that I will encounter in the process of work.
 I do not apply for the last instance and this information will be of a fact-finding character.
 Therefore, here are my contacts and if you have an irresistible desire to discuss these
 topics - write here or in the comments, I will be happy.</p>
</div>`};

const Blog = {
    template: `<div class="blog-content ">
    <h3>latest news</h3>
        <div class="container">
    <ul class="news-item-list ">
        <li v-for="item in items"
            class="news-item">
            <p class="news-item-title">{{item.name}}</p>
            <p class="news-item-description">{{item.description}}</p>
            <div>
                <span class="posted-date">19 jun 2017</span>
                <span class="updated-date">Last updated: 21 jun 2017</span>
                <span class="share-post">Share</span>
            </div>
        </li>
    </ul>
        </div>
</div>`,
        
    data: function () {
        return {
            items: []
        };
    },

    created() {
        this.fethPostsData();
    },

    watch: {
        // в случае изменения маршрута запрашиваем данные вновь
        '$route': 'fetchData'
    },

    methods: {
        fethPostsData: function () {
            console.log(1);
            var self = this;
            $.ajax({
                url: "api/posts",
                type: "GET",
                contentType: "application/json",
                success: function (posts) {
                    self.items = posts;
                    console.log(self.items);
                },
                error: function () {
                    console.log('sukablyat');
                }
            });
        }
    }
};

const Admin = {
    template: `<div class="blog-content" v-if="authorized">
    <h3>latest news</h3>
    <form name="postsForm" @submit.prevent="onSubmit">
        <input type="hidden" name="id" value="0" />
        <div class="form-group">
            <input class="form-control"
                   name="name"
                   placeholder="Title"
                   v-model="name"/>
        </div>
        <div class="form-group">
            <textarea class="form-control"
                   name="description"
                   placeholder="Text"
                   v-model="description"></textarea>
        </div>
        <div class="panel-body">
            <button type="submit"
                    class="btn btn-sm btn-primary">Save</button>
            <button>Cancel</button>
            <button @click="logout()">Log out</button>
        </div>
    </form>
    <ul class="news-item-list container">
        <li v-for="item in items"
            class="news-item">
            <p class="news-item-title">{{item.name}}</p>
            <p class="news-item-description">{{item.description}}</p>
            <button @click="editPost(item)">Edit</button>
            <button @click="deletePost(item._id)">Delete</button>
        </li>
    </ul>
</div>`,
        
    data: function () {
        return {
            items: [],
            id: '',
            description: '',
            name: '',
            edit: false,
            authorized: false
        };
    },

    created() {
        this.fethPostsData();
    },

    watch: {
        // в случае изменения маршрута запрашиваем данные вновь
        '$route': 'fetchData'
    },

    methods: {
        fethPostsData: function () {
            console.log(1);
            var self = this;
            $.ajax({
                url: "/admin",
                type: "GET",
                contentType: "application/json",
                success: function (posts) {
                    self.items = posts;
                    console.log(self.items);
                    self.authorized = true;
                },
                error: function () {
                    console.log('sukablyat');
                }
            });
        },
        
        logout: function(){
             $.ajax({
                    url: "/logout",
                    contentType: "application/json",
                    method: "GET",          
                    success: function () {
                        console.log('exit');
                        }               
                });
        },

        onSubmit: function () {
            var name = this.name;
            var description = this.description;
            var id = this.id;
            var self = this;
            if(this.edit){
                $.ajax({
                    url: "api/posts",
                    contentType: "application/json",
                    method: "PUT",
                    data: JSON.stringify({
                        id: id,
                        name: name,
                        description: description
                    }),
                    success: function (post) {
                        for (var i = 0; i < self.items.length; i++) {
                            if (self.items[i]._id == post._id) {
                                self.items[i].name = name;
                                self.items[i].description = description;
                                break;
                            }
                        }
                        self.description = '';
                        self.name = '';
                        self.edit = false;
                        console.log(post);
                    }
                });
            }else{
                $.ajax({
                    url: "api/posts",
                    contentType: "application/json",
                    method: "POST",
                    data: JSON.stringify({
                        name: name,
                        description: description
                    }),
                    success: function (post) {
                        self.items.push(post);
                        self.description = '';
                        self.name = '';
                    }
                });
            }
        },
        
        onCancel: function(){
            this.description = '';
            this.name = '';
        },
        
        editPost: function(item){
            this.name = item.name;
            this.description  = item.description;
            this.id = item._id;
            this.edit = true;
        },

        deletePost: function (id) {
            var self = this;
            $.ajax({
                url: "api/posts/" + id,
                contentType: "application/json",
                method: "DELETE",
                success: function () {
                    for (var i = 0; i < self.items.length; i++) {
                        if (self.items[i]._id == id) {
                            self.items.splice(i, 1);
                            break;
                        }
                    }
                }
            });
        }
    }
};

// 2. Определение путей
// Каждый путь должен указывать на компонент
// "Компонентом" может быть как созданный через `Vue.extend()`
// полноценный конструктор, так и просто объект с настройками компонента
// Вложенные пути будут рассмотрены далее.
const routes = [
    {path: '/', component: Home},
    {path: '/blog', component: Blog},
    {path: '/works', component: Works},
    {path: '/contact', component: Contact},
    {path: '/about', component: About},
    {path: '/admin', component: Admin}
];

//import Vue from 'vue';
//import VueRouter from 'vue-router';

// 3. Создаём инстанс роутера с опцией `routes`
// Можно передать и другие опции, но пока не будем усложнять
const router = new VueRouter({
    routes
});


// 4. Создаём и монтируем корневой инстанс Vue нашего приложения.
// Удостоверьтесь, что передали инстанс роутера в опции `router`,
// что позволит приложению знать о его наличии
const app = new Vue({
    router: router,
    el: '#main-page',
    data: {

    }
});

//        GetPost: function (id) {
//            $.ajax({
//                url: "/api/posts/" + id,
//                type: "GET",
//                contentType: "application/json",
//                success: function (post) {
//                    var form = document.forms["postsForm"];
//                    form.elements["id"].value = post._id;
//                    form.elements["name"].value = post.name;
//                    form.elements["description"].value = post.description;
//                }
//            });
//        }
        </script>


    </body>
</html>